
CREATE PROCEDURE [dbo].[SP_GET_PREFERENCIAL_PLAN_INFO_GET_RESULT]
(
	 @TAX_CODE		INT				-- Код на таксата за която търсим преференцията
     , @PREF_CODE INT	OUT			-- Това ще е кода на преференцията която ще върнем накрая
)
AS
	SELECT DISTINCT 
			PREFERENCIAL_PLANS_HDR.CODE,
			PREFERENCIAL_PLANS.DEPEND_TYPE,
			PREFERENCIAL_PLANS.BALANCE_TURNOVER_TYPE,
			PREFERENCIAL_PLANS.STATUS AS STS_PLAN,
			PREFERENCIAL_PLANS_HDR.STATUS AS STS_HDR_PLAN,
			PREF_DEAL_TYPE_CODE,
			TAX_CODE,
			CODE_PREFERENCE,
			ISNULL( DT_SUB_GROUPS.DEAL_TURNOVER_SUB_GROUP_CODE, 0 ) AS DT_OPER_CODE_SUBS_GROUP, 
			ISNULL( KT_SUB_GROUPS.DEAL_TURNOVER_SUB_GROUP_CODE, 0 ) AS CT_OPER_CODE_SUBS_GROUP,
			CAST(1 AS SMALLINT) AS PREFERENCIAL_PLAN_TYPE
	FROM PREFERENCIAL_PLANS_HDR WITH( NOLOCK ) 
	INNER JOIN PREFERENCIAL_EVENTS_TAXES WITH( NOLOCK ) 
		ON  PREFERENCIAL_EVENTS_TAXES.PREFERENCE_CODE = PREFERENCIAL_PLANS_HDR.CODE_PREFERENCE
		AND PREFERENCIAL_EVENTS_TAXES.PREF_PLAN_CODE  = PREFERENCIAL_PLANS_HDR.CODE
		AND PREFERENCIAL_EVENTS_TAXES.TAX_CODE		  =	@TAX_CODE
	INNER JOIN PREFERENCIAL_PLANS WITH( NOLOCK )
		ON PREFERENCIAL_PLANS.CODE_PREF_PLAN_HRD = PREFERENCIAL_PLANS_HDR.CODE
		AND PREFERENCIAL_PLANS.PREFERENCE_CODE = PREFERENCIAL_PLANS_HDR.CODE_PREFERENCE
	LEFT JOIN PREFERENTIAL_PLAN_DEAL_TURNOVER_SUB_GROUPS AS DT_SUB_GROUPS WITH( NOLOCK ) 
		ON PREFERENCIAL_PLANS.PREFERENCE_CODE = DT_SUB_GROUPS.PREFERENTIAL_TAX_CODE 
		AND PREFERENCIAL_PLANS.CODE = DT_SUB_GROUPS.PREFERENTIAL_PLAN_CODE 
		AND DT_SUB_GROUPS.TYPE_OPERATION = 1/*Debit*/ 
	LEFT JOIN PREFERENTIAL_PLAN_DEAL_TURNOVER_SUB_GROUPS AS KT_SUB_GROUPS WITH( NOLOCK ) 
		ON PREFERENCIAL_PLANS.PREFERENCE_CODE = KT_SUB_GROUPS.PREFERENTIAL_TAX_CODE 
		AND PREFERENCIAL_PLANS.CODE = KT_SUB_GROUPS.PREFERENTIAL_PLAN_CODE 
		AND KT_SUB_GROUPS.TYPE_OPERATION = 2/*Kredit*/ 
	WHERE	PREFERENCIAL_PLANS_HDR.CODE_PREFERENCE = @PREF_CODE

	UNION

	SELECT DISTINCT 
			PREFERENCIAL_PLANS_HDR.CODE,
			CAST(0 AS SMALLINT),
			CAST(0 AS SMALLINT),
			0X00000000,
			PREFERENCIAL_PLANS_HDR.STATUS AS STS_HDR_PLAN,
			0,
			TAX_CODE,
			CODE_PREFERENCE,
			0,
			0,
			CAST(2 AS SMALLINT)
	FROM PREFERENCIAL_PLANS_HDR WITH( NOLOCK ) 
	INNER JOIN PREFERENCIAL_EVENTS_TAXES WITH( NOLOCK ) 
		ON  PREFERENCIAL_EVENTS_TAXES.PREFERENCE_CODE = PREFERENCIAL_PLANS_HDR.CODE_PREFERENCE
		AND PREFERENCIAL_EVENTS_TAXES.PREF_PLAN_CODE  = PREFERENCIAL_PLANS_HDR.CODE
		AND PREFERENCIAL_EVENTS_TAXES.TAX_CODE		  =	@TAX_CODE
	INNER JOIN DISCOUNT_PENALTY_PREFERENCIAL_PLANS WITH( NOLOCK )
		ON DISCOUNT_PENALTY_PREFERENCIAL_PLANS.PREFERENCIAL_PLANS_HDR_CODE = PREFERENCIAL_PLANS_HDR.CODE
	WHERE	PREFERENCIAL_PLANS_HDR.CODE_PREFERENCE = @PREF_CODE
GO

